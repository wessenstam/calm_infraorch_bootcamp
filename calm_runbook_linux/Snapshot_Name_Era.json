{"status":{},"contains_secrets":false,"product_version":"3.2.2","spec":{"description":"","resources":{"endpoints_information":[],"endpoint_definition_list":[],"credential_definition_list":[{"username":"root","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"root"}],"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"FiestaDB registered"},{"kind":"app_task","name":"Create Era snapshot"}],"name":"2200f475_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"FiestaDB registered"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Era snapshot"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"FiestaDB registered","attrs":{"failure_child_reference":{"kind":"app_task","name":"16e27caa_FAILURE_META"},"exit_status":[],"script":"#!\/bin\/bash\n\n# Set the vars needed by the Calm Runbook variables\nera_ip=\"@@{era_ip}@@\"\nera_user=\"@@{era_user}@@\"\nera_password=\"@@{era_password}@@\"\ninitials=\"@@{initials}@@\"\n\necho \"Checking if the FiestaDB is registered\"\n\ndatabase_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/databases\" --silent -H 'Content-Type: application\/json' | jq --arg name $initials\"-FiestaDB-Lin\" '.[] | select (.name==$name) .id' | tr -d \\\")\n\nif [ -z $database_id ]\nthen\n    exit 1\nelse\n    exit 0\nfi","login_credential_local_reference":{"kind":"app_credential","name":"root"},"success_child_reference":{"kind":"app_task","name":"a1dd3462_SUCCESS_META"},"type":"","command_line_args":"","script_type":"sh"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"FiestaDB registered_2"}],"name":"a1dd3462_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"FiestaDB registered_2","attrs":{"exit_status":[],"script":"echo \"Found @@{initials}@@-FiestaDB-Lin in Era\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"root"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Register FiestaDB"}],"name":"16e27caa_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register FiestaDB","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n# Set the vars needed by the Calm Runbook variables\nera_ip=\"@@{era_ip}@@\"\nera_user=\"@@{era_user}@@\"\nera_password=\"@@{era_password}@@\"\ninitials=\"@@{initials}@@\"\nhostip=$(hostname -I)\nhost_ip=${hostip::-1}\n\n# Get Era Custer ID\nera_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/clusters\" --silent -H 'Content-Type: application\/json' | jq --arg name \"EraCluster\" '.[] | select (.name==$name) .id' | tr -d \\\")\n\n# Get the UUID of the Bronze SLA\nsla_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/slas\" --silent -H 'Content-Type: application\/json' | jq --arg name \"DEFAULT_OOB_BRONZE_SLA\" '.[] | select (.name==$name) .id' | tr -d \\\")\n\n# Build the payload json for Era\npayload=$(cat <<EOF\n{\n  \"actionArguments\": [\n    {\n      \"name\": \"listener_port\",\n      \"value\": \"3306\"\n    },\n    {\n      \"name\": \"db_user\",\n      \"value\": \"root\"\n    },\n    {\n      \"name\": \"vmIp\",\n      \"value\": \"${host_ip}\"\n    },\n    {\n      \"name\": \"software_home\",\n      \"value\": \"\/usr\"\n    },\n    {\n      \"name\": \"db_name\",\n      \"value\": \"FiestaDB\"\n    },\n    {\n      \"name\": \"db_password\",\n      \"value\": \"nutanix\/4u\"\n    }\n  ],\n  \"nxClusterId\": \"${era_id}\",\n  \"databaseType\": \"mariadb_database\",\n  \"databaseName\": \"${initials}-FiestaDB-Lin\",\n  \"description\": \"\",\n  \"clustered\": false,\n  \"forcedInstall\": true,\n  \"category\": \"DEFAULT\",\n  \"vmIp\": \"${host_ip}\",\n  \"vmUsername\": \"centos\",\n  \"vmPassword\": \"nutanix\/4u\",\n  \"vmSshkey\": \"\",\n  \"vmDescription\": \"\",\n  \"autoTuneStagingDrive\": true,\n  \"workingDirectory\": \"\/tmp\",\n  \"timeMachineInfo\": {\n    \"autoTuneLogDrive\": true,\n    \"slaId\": \"${sla_id}\",\n    \"schedule\": {\n      \"snapshotTimeOfDay\": {\n        \"hours\": 1,\n        \"minutes\": 0,\n        \"seconds\": 0\n      },\n      \"continuousSchedule\": {\n        \"enabled\": true,\n        \"logBackupInterval\": 30,\n        \"snapshotsPerDay\": 1\n      },\n      \"weeklySchedule\": {\n        \"enabled\": true,\n        \"dayOfWeek\": \"TUESDAY\"\n      },\n      \"monthlySchedule\": {\n        \"enabled\": true,\n        \"dayOfMonth\": \"18\"\n      },\n      \"quartelySchedule\": {\n        \"enabled\": true,\n        \"startMonth\": \"JANUARY\",\n        \"dayOfMonth\": \"18\"\n      },\n      \"yearlySchedule\": {\n        \"enabled\": false,\n        \"dayOfMonth\": 31,\n        \"month\": \"DECEMBER\"\n      }\n    },\n    \"tags\": [],\n    \"name\": \"${initials}-FiestaDB-Lin_TM\"\n  },\n  \"tags\": []\n}\nEOF\n)\n\n\n# Register the Database of initials-FiestaDB\noperation_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/databases\/register\" -X POST --data \"${payload}\" --silent -H 'Content-Type: application\/json' | jq '.operationId' | tr -d \\\")\n\n# Running small waiting loop \ncounter=0\nwhile true\ndo\n    ((counter=counter+1))\n    # Get the status of the task\n    status=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/operations\/$operation_id\" --silent -H 'Content-Type: application\/json' | jq '.status' | tr -d \\\")\n    \n    if [[ \"${status}\" != 5 ]] && [[ \"${status}\" != 4 ]]\n    then\n        echo \"Registration is still running $counter\/15. Sleeping 1 minute before retrying...\"\n        sleep 60\n    else\n    \tbreak\n    fi\ndone\n\nif [[ \"${status}\" == 5 ]]\nthen\n    echo \"Registration has been successfull.\"\n    exit 0\nelse\n    echo \"Registration has not been successfull. Exiting\"\n    exit 1\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"root"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Era snapshot","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n# Set the vars needed by the Calm Runbook variables\nera_ip=\"@@{era_ip}@@\"\nera_user=\"@@{era_user}@@\"\nera_password=\"@@{era_password}@@\"\ninitials=\"@@{initials}@@\"\nsnapshotname=\"@@{snapshotname}@@\"\n\necho \"Create snapshot FirstSnapshot_Runbook for $initials-FiestaDB-Lin\"\n# Get Era Custer ID\ntms_uuid=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/tms\" --silent -H 'Content-Type: application\/json' | jq --arg name $initials\"-FiestaDB-Lin_TM\" '.[] | select (.name==$name) .id' | tr -d \\\")\n\necho $tms_uuid\n# Build the Payload\npayload=$(cat <<EOF\n{\n    \"name\":\"$snapshotname\"\n}\nEOF\n)\necho $payload\n\n# Register the Database of initials-FiestaDB\noperation_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/tms\/$tms_uuid\/snapshots\" -X POST --data \"${payload}\" --silent -H 'Content-Type: application\/json' | jq '.operationId' | tr -d \\\")\n\n# Running small waiting loop \ncounter=0\nwhile true\ndo\n    ((counter=counter+1))\n    # Get the status of the task\n    status=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/operations\/$operation_id\" --silent -H 'Content-Type: application\/json' | jq '.status' | tr -d \\\")\n    \n    if [[ \"${status}\" != 5 ]] && [[ \"${status}\" != 4 ]]\n    then\n        echo \"Snapshot creation is still running $counter\/15. Sleeping 1 minute before retrying...\"\n        sleep 60\n    else\n    \tbreak\n    fi\ndone\n\nif [[ \"${status}\" == 5 ]]\nthen\n    echo \"Snapshot creation has been successfull.\"\n    exit 0\nelse\n    echo \"Snapshot creation has not been successfull. Exiting\"\n    exit 1\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"root"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"b46824ff_runbook","main_task_local_reference":{"kind":"app_task","name":"2200f475_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"initials","value":"xyz","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"era_user","value":"admin","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"era_password","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"era_ip","value":"10.38.20.60","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"snapshotname","value":"test2","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"client_attrs":{},"default_target_reference":{"kind":"app_endpoint","name":"xyz-mariadb"}},"name":"xyz-Create MariaDB Snapshot"},"api_version":"3.0","metadata":{"last_update_time":"1621423155291091","kind":"runbook","spec_version":56,"creation_time":"1621339322934759","name":"xyz-Create MariaDB Snapshot"}}
{"status":{},"contains_secrets":false,"product_version":"3.2.2","spec":{"description":"","resources":{"endpoints_information":[],"endpoint_definition_list":[],"credential_definition_list":[{"username":"root","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"root"}],"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Task 1"}],"name":"76c0aa15_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task 1","attrs":{"failure_child_reference":{"kind":"app_task","name":"ebda5ba7_FAILURE_META"},"exit_status":[],"script":"#!\/bin\/bash\n\n# Set the vars needed by the Calm Runbook variables\nera_ip=\"@@{era_ip}@@\"\nera_user=\"@@{era_user}@@\"\nera_password=\"@@{era_password}@@\"\ninitials=\"@@{initials}@@\"\nsnapshotname=\"@@{snapshotname}@@\"\n\necho \"Checking if there is a snapshot with the name $snapshotname\"\n\nsnapshot_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/snapshots\" --silent -H 'Content-Type: application\/json' | jq --arg name $snapshotname '.[] | select (.name==$name) .id' | tr -d \\\")\n\nif [[ -z $snapshot_id ]]\nthen\n    exit 1\nelse    \n    exit 0\nfi","login_credential_local_reference":{"kind":"app_credential","name":"root"},"success_child_reference":{"kind":"app_task","name":"168218a6_SUCCESS_META"},"type":"","command_line_args":"","script_type":"sh"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Snapshot Exists"},{"kind":"app_task","name":"Restore snaphot "}],"name":"168218a6_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Snapshot Exists","attrs":{"exit_status":[],"script":"#!\/bin\/bash\necho \"Snapshot with name @@{snapshotname}@@ found\"\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"root"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Restore snaphot ","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\n# Set the vars needed by the Calm Runbook variables\nera_ip=\"@@{era_ip}@@\"\nera_user=\"@@{era_user}@@\"\nera_password=\"@@{era_password}@@\"\ninitials=\"@@{initials}@@\"\nsnapshotname=\"@@{snapshotname}@@\"\n\necho \"Restoring snapshot $snapshot\"\n# Get snapshot uuid for the snapshot we need\nsnapshot_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/snapshots\" --silent -H 'Content-Type: application\/json' | jq --arg name $snapshotname '.[] | select (.name==$name) .id' | tr -d \\\")\n\n# Get UUId for the databse\ndatabase_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/databases\" --silent -H 'Content-Type: application\/json' | jq --arg name $initials\"-FiestaDB-Lin\" '.[] | select (.name==$name) .id' | tr -d \\\")\n\n# Building Payload\npayload=$(cat <<EOF\n{\n    \"snapshotId\": \"$snapshot_id\",\n    \"latestSnapshot\": null,\n    \"userPitrTimestamp\": null,\n    \"actionArguments\": [\n      {\n        \"name\": \"sameLocation\",\n        \"value\": \"true\"\n      }\n    ]\n  }\nEOF\n)\n\n# Start restore of the database\noperation_id=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/databases\/$database_id\/restore\" -X POST --data \"${payload}\" --silent -H 'Content-Type: application\/json' | jq '.operationId' | tr -d \\\")\n\n# Running small waiting loop \ncounter=0\nwhile true\ndo\n    ((counter=counter+1))\n    # Get the status of the task\n    status=$(curl --insecure --user $era_user:$era_password \"https:\/\/$era_ip\/era\/v0.9\/operations\/$operation_id\" --silent -H 'Content-Type: application\/json' | jq '.status' | tr -d \\\")\n    \n    if [[ \"${status}\" != 5 ]] && [[ \"${status}\" != 4 ]]\n    then\n        echo \"Snapshot creation is still running $counter\/15. Sleeping 1 minute before retrying...\"\n        sleep 60\n    else\n    \tbreak\n    fi\ndone\n\nif [[ \"${status}\" == 5 ]]\nthen\n    echo \"Snapshot creation has been successfull.\"\n    exit 0\nelse\n    echo \"Snapshot creation has not been successfull. Exiting\"\n    exit 1\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"root"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Snapshot does not exist"}],"name":"ebda5ba7_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Snapshot does not exist","attrs":{"exit_status":[],"script":"#!\/bin\/bash\necho \"Snapshot with name @@{snapshotname}@@ not found\"\necho \"The Runbook can not progress\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"root"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"dc59901a_runbook","main_task_local_reference":{"kind":"app_task","name":"76c0aa15_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"initials","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"era_user","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"era_password","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"era_ip","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"snapshotname","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"client_attrs":{},"default_target_reference":{"kind":"app_endpoint","name":"xyz-mariadb"}},"name":"Restore MariaDB from snapshot"},"api_version":"3.0","metadata":{"last_update_time":"1621424255466226","kind":"runbook","spec_version":2,"creation_time":"1621424108915800","name":"Restore MariaDB from snapshot"}}